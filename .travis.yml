language: java
jdk:
  - oraclejdk8

branches:
  only:
  - eval-travis-ci

dist: trusty
group: edge

cache:
  directories:
  - $HOME/.m2
  - $PWD/libcuckoo
  - $PWD/medida
  - $PWD/cityhash

before_install:
  - sudo apt-get remove cmake
  - wget https://cmake.org/files/v3.8/cmake-3.8.2-Linux-x86_64.tar.gz -O /tmp/cmake.tar.gz
  - tar -xf /tmp/cmake.tar.gz
  - export PATH=$PATH:$PWD/cmake-3.8.2-Linux-x86_64/bin/

install:
  - sudo apt-get -qq update
  - sudo apt-get install -y tree libunittest++-dev libboost-all-dev libprotobuf-dev protobuf-compiler elfutils libelf-dev valgrind libunwind8-dev
  - elfutil_version=$(dpkg -l | grep libelf | grep dev | awk '{print $3}' | sed -e 's/-.\+//g')
  - sed -i 's/{{elfutil_version}}/'${elfutil_version}'/g' libelf.pc
  - sudo mv libelf.pc /usr/lib/pkgconfig/libelf.pc
before_script:
  - mkdir -p libcuckoo && pushd libcuckoo && git init && git remote add origin https://github.com/efficient/libcuckoo.git && git pull origin master && git checkout v0.2 && cmake . && sudo make install && popd
  - mkdir -p medida && pushd medida && git init && git remote https://github.com/janmejay/medida.git && git pull origin master && cmake CMakeLists.txt && sudo make install && popd
  - mkdir -p cityhash && pushd cityhash && git init && git remote add origin https://github.com/google/cityhash.git && git pull origin master && git checkout 8af9b8c2b889d80c22d6bc26ba0df1afb79a30db && ./configure && make all check CXXFLAGS="-g -O3" && sudo make install && sudo ldconfig && popd
script:
  - pushd recorder && cmake CMakeLists.txt && make && popd
  - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
  - mvn test -B
